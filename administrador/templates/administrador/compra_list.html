{% extends 'administrador/base_dashboard.html' %}
{% load static %}

{% block title %}Gesti√≥n de Compras{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Gesti√≥n de Compras</h3>
                    <button class="btn btn-primary" onclick="openModal()">
                        <i class="fas fa-plus"></i> Registrar Compra
                    </button>
                </div>
                <div class="card-body">
                    <!-- Aqu√≠ va la tabla y funcionalidad de compras -->
                    <div class="search-bar mb-3">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Buscar compra por proveedor, fecha o estado...">
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Estado</th>
                                <th>Total</th>
                                <th>M√©todo Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table">
                            {% for compra in compras %}
                            <tr>
                                <td><strong>{{ compra.numero_compra }}</strong></td>
                                <td>{{ compra.fecha_solicitud|date:"d/m/Y" }}</td>
                                <td>{{ compra.proveedor.razon_social }}</td>
                                <td>
                                    <span class="badge
                                        {% if compra.estado == 'PAGADA' %}badge-success
                                        {% elif compra.estado == 'APROBADA' %}badge-info
                                        {% elif compra.estado == 'SOLICITUD' %}badge-warning
                                        {% else %}badge-danger{% endif %}">
                                        {{ compra.get_estado_display }}
                                    </span>
                                </td>
                                <td><strong>${{ compra.total|floatformat:0 }}</strong></td>
                                <td>{{ compra.get_metodo_pago_display|default:"N/A" }}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-success" onclick="viewPurchase('{{ compra.id }}')" style="padding: 6px 12px; font-size: 12px;">üëÅÔ∏è</button>
                                    <button class="btn btn-primary" onclick="editPurchase('{{ compra.id }}')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    No hay compras registradas
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar compra -->
<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Registrar Compra</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="purchase-form" method="post" action="{% url 'administrador:compra_list' %}">
            {% csrf_token %}
            <input type="hidden" id="purchase-id" name="compra_id">

            <div class="form-group">
                <label for="numero_compra">N√∫mero de Compra</label>
                <input type="text" id="numero_compra" name="numero_compra" class="form-control" required placeholder="CMP-001">
            </div>

            <div class="form-group">
                <label for="proveedor">Proveedor</label>
                <select id="proveedor" name="proveedor" class="form-control" required>
                    <option value="">Seleccione un proveedor</option>
                    {% for proveedor in proveedores %}
                    <option value="{{ proveedor.id }}">{{ proveedor.razon_social }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="fecha_solicitud">Fecha de Solicitud</label>
                <input type="datetime-local" id="fecha_solicitud" name="fecha_solicitud" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" name="estado" class="form-control" required>
                    <option value="SOLICITUD">Solicitud</option>
                    <option value="COTIZACION">Cotizaci√≥n</option>
                    <option value="APROBADA">Aprobada</option>
                    <option value="PEDIDO_ENVIADO">Pedido Enviado</option>
                    <option value="RECIBIDA_PARCIAL">Recibida Parcial</option>
                    <option value="RECIBIDA_COMPLETA">Recibida Completa</option>
                    <option value="FACTURADA">Facturada</option>
                    <option value="PAGADA">Pagada</option>
                </select>
            </div>

            <div class="form-group">
                <label for="subtotal">Subtotal</label>
                <input type="number" id="subtotal" name="subtotal" class="form-control" required min="0" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="impuestos">Impuestos</label>
                <input type="number" id="impuestos" name="impuestos" class="form-control" required min="0" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="total">Total</label>
                <input type="number" id="total" name="total" class="form-control" required min="0" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="metodo_pago">M√©todo de Pago</label>
                <select id="metodo_pago" name="metodo_pago" class="form-control">
                    <option value="">Seleccione m√©todo</option>
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia Bancaria</option>
                    <option value="CHEQUE">Cheque</option>
                    <option value="CREDITO">Cr√©dito</option>
                    <option value="TARJETA_CREDITO">Tarjeta de Cr√©dito</option>
                </select>
            </div>

            <div class="form-group">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" name="observaciones" class="form-control" rows="3" placeholder="Notas adicionales..."></textarea>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Compra</button>
            </div>
        </form>
    </div>
</div>

<script>
    function searchPurchases() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const rows = document.querySelectorAll('#purchases-table tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm) || searchTerm === '') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function openModal() {
        document.getElementById('modal').classList.add('active');
        document.getElementById('modal-title').textContent = 'Registrar Compra';
        document.getElementById('purchase-form').reset();

        // Establecer fecha actual
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('fecha_solicitud').value = now.toISOString().slice(0, 16);
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
        document.getElementById('purchase-form').reset();
    }

    function viewPurchase(id) {
        window.location.href = `/administrador/compras/${id}/`;
    }

    function editPurchase(id) {
        // Implementar l√≥gica de edici√≥n
        showAlert('Funcionalidad de edici√≥n en desarrollo');
    }

    function showAlert(message, type = 'success') {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);

        setTimeout(() => alert.remove(), 3000);
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // Calcular total autom√°ticamente
    document.getElementById('subtotal').addEventListener('input', calculateTotal);
    document.getElementById('impuestos').addEventListener('input', calculateTotal);

    function calculateTotal() {
        const subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
        const impuestos = parseFloat(document.getElementById('impuestos').value) || 0;
        document.getElementById('total').value = (subtotal + impuestos).toFixed(2);
    }

    // Mostrar mensajes de Django
    {% if messages %}
        {% for message in messages %}
            showAlert('{{ message }}', '{{ message.tags }}');
        {% endfor %}
    {% endif %}
</script>
{% endblock %}
