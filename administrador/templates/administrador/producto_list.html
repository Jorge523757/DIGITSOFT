{% extends 'administrador/base_list.html' %}
{% load static %}

{% block title %}Productos | Digit Soft{% endblock %}
{% block page_header %}Productos{% endblock %}

{% block list_title %}Gestión de Productos{% endblock %}
{% block list_description %}Administra el inventario de productos y servicios{% endblock %}

{% block table_headers %}
<th>Código</th>
<th>Nombre</th>
<th>Categoría</th>
<th>Marca</th>
<th>Precio Venta</th>
<th>Stock</th>
<th>Estado</th>
<th style="width: 200px;">Acciones</th>
{% endblock %}

{% block table_body %}
{% if productos %}
    {% for producto in productos %}
    <tr>
        <td><strong>{{ producto.codigo_producto }}</strong></td>
        <td>{{ producto.nombre }}</td>
        <td>{{ producto.get_categoria_display }}</td>
        <td>{{ producto.marca.nombre|default:"Sin marca" }}</td>
        <td>${{ producto.precio_venta|floatformat:2 }}</td>
        <td>
            {% if producto.stock_actual <= producto.stock_minimo %}
                <span class="badge badge-danger">{{ producto.stock_actual }}</span>
            {% elif producto.stock_actual <= producto.stock_minimo|add:10 %}
                <span class="badge badge-warning">{{ producto.stock_actual }}</span>
            {% else %}
                <span class="badge badge-success">{{ producto.stock_actual }}</span>
            {% endif %}
        </td>
        <td>
            {% if producto.activo %}
                <span class="badge badge-success">Activo</span>
            {% else %}
                <span class="badge badge-danger">Inactivo</span>
            {% endif %}
        </td>
        <td>
            <div class="actions-cell">
                <button class="btn btn-info btn-sm" onclick="viewDetails({{ producto.id }})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-primary btn-sm" onclick="editRecord({{ producto.id }})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="viewHistory({{ producto.id }}, '{{ producto.nombre }}')" title="Historial">
                    <i class="fas fa-history"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="confirmDelete({{ producto.id }}, '{{ producto.nombre }}', '{{ producto.codigo_producto }}', '{{ producto.precio_venta }}', {{ producto.stock_actual }})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="8" class="empty-state">
            <i class="fas fa-box-open"></i>
            <p>No hay productos registrados</p>
            <button class="btn btn-primary" onclick="openModal('createModal')">
                <i class="fas fa-plus"></i> Agregar Primer Producto
            </button>
        </td>
    </tr>
{% endif %}
{% endblock %}

{% block form_content %}
<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Código del Producto *</label>
            {{ form.codigo_producto }}
            {% if form.codigo_producto.errors %}
                <small class="text-danger">{{ form.codigo_producto.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Nombre *</label>
            {{ form.nombre }}
            {% if form.nombre.errors %}
                <small class="text-danger">{{ form.nombre.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Descripción</label>
    {{ form.descripcion }}
    {% if form.descripcion.errors %}
        <small class="text-danger">{{ form.descripcion.errors.0 }}</small>
    {% endif %}
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Categoría *</label>
            {{ form.categoria }}
            {% if form.categoria.errors %}
                <small class="text-danger">{{ form.categoria.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Marca *</label>
            {{ form.marca }}
            {% if form.marca.errors %}
                <small class="text-danger">{{ form.marca.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Modelo</label>
            {{ form.modelo }}
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Proveedor Principal *</label>
            {{ form.proveedor_principal }}
            {% if form.proveedor_principal.errors %}
                <small class="text-danger">{{ form.proveedor_principal.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Precio de Compra *</label>
            {{ form.precio_compra }}
            {% if form.precio_compra.errors %}
                <small class="text-danger">{{ form.precio_compra.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Precio de Venta *</label>
            {{ form.precio_venta }}
            {% if form.precio_venta.errors %}
                <small class="text-danger">{{ form.precio_venta.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="form-group">
            <label class="form-label">Stock Actual *</label>
            {{ form.stock_actual }}
            {% if form.stock_actual.errors %}
                <small class="text-danger">{{ form.stock_actual.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="form-label">Stock Mínimo *</label>
            {{ form.stock_minimo }}
            {% if form.stock_minimo.errors %}
                <small class="text-danger">{{ form.stock_minimo.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="form-label">Stock Máximo *</label>
            {{ form.stock_maximo }}
            {% if form.stock_maximo.errors %}
                <small class="text-danger">{{ form.stock_maximo.errors.0 }}</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Ubicación en Almacén</label>
            {{ form.ubicacion_almacen }}
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label class="form-label">Garantía (meses)</label>
            {{ form.garantia_meses }}
        </div>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Imagen del Producto</label>
    {{ form.imagen }}
</div>

<div class="form-group">
    <div class="form-check">
        {{ form.es_servicio }}
        <label class="form-check-label" for="{{ form.es_servicio.id_for_label }}">
            ¿Es un servicio? (no es un producto físico)
        </label>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Calcular margen de ganancia automáticamente
const precioCompra = document.querySelector('[name="precio_compra"]');
const precioVenta = document.querySelector('[name="precio_venta"]');

if (precioCompra && precioVenta) {
    function calcularMargen() {
        const compra = parseFloat(precioCompra.value) || 0;
        const venta = parseFloat(precioVenta.value) || 0;

        if (compra > 0 && venta > 0) {
            const margen = ((venta - compra) / compra * 100).toFixed(2);
            const mensaje = margen >= 0 ? `Margen: ${margen}%` : `⚠️ Pérdida: ${Math.abs(margen)}%`;

            // Mostrar mensaje temporal
            if (!document.getElementById('margenInfo')) {
                const info = document.createElement('small');
                info.id = 'margenInfo';
                info.style.color = margen >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                precioVenta.parentNode.appendChild(info);
            }
            document.getElementById('margenInfo').textContent = mensaje;
        }
    }

    precioCompra.addEventListener('input', calcularMargen);
    precioVenta.addEventListener('input', calcularMargen);
}

// Validar que el precio de venta no sea menor al de compra
precioVenta.addEventListener('blur', function() {
    const compra = parseFloat(precioCompra.value) || 0;
    const venta = parseFloat(precioVenta.value) || 0;

    if (venta < compra && compra > 0) {
        if (confirm('El precio de venta es menor al de compra. ¿Deseas continuar?')) {
            // Continuar
        } else {
            precioVenta.value = (compra * 1.3).toFixed(2); // Sugerir 30% de margen
            calcularMargen();
        }
    }
});

// Alertar cuando el stock esté bajo
const stockActual = document.querySelector('[name="stock_actual"]');
const stockMinimo = document.querySelector('[name="stock_minimo"]');

if (stockActual && stockMinimo) {
    stockActual.addEventListener('blur', function() {
        const actual = parseInt(this.value) || 0;
        const minimo = parseInt(stockMinimo.value) || 0;

        if (actual <= minimo && minimo > 0) {
            showNotification('⚠️ Stock bajo o igual al mínimo', 'warning');
        }
    });
}
</script>
{% endblock %}
