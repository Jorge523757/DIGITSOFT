{% extends 'administrador/base_dashboard.html' %}
{% load static %}

{% block title %}Gestión de Técnicos | Digit Soft{% endblock %}
{% block page_header %}Gestión de Técnicos{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Gestión de Técnicos</h3>
                    <button class="btn btn-primary" onclick="openModal()">
                        <i class="fas fa-plus"></i> Registrar Técnico
                    </button>
                </div>
                <div class="card-body">
                    <!-- Barra de búsqueda -->
                    <div class="search-bar mb-3">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Buscar técnico por nombre, documento o especialidad..." oninput="searchTechnicians()">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchTechnicians()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de técnicos -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover data-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Documento</th>
                                    <th>Técnico</th>
                                    <th>Especialidades</th>
                                    <th>Nivel</th>
                                    <th>Estado</th>
                                    <th>Teléfono</th>
                                    <th>Calificación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tecnico in tecnicos %}
                                <tr>
                                    <td><strong>{{ tecnico.numero_documento }}</strong></td>
                                    <td>{{ tecnico.nombre_completo }}</td>
                                    <td>
                                        <span class="badge badge-info">
                                            {{ tecnico.especialidades|truncatechars:30 }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if tecnico.nivel_experiencia == 'SENIOR' %}badge-success
                                            {% elif tecnico.nivel_experiencia == 'INTERMEDIO' %}badge-warning
                                            {% else %}badge-secondary{% endif %}">
                                            {{ tecnico.get_nivel_experiencia_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if tecnico.estado_actual == 'DISPONIBLE' %}badge-success
                                            {% elif tecnico.estado_actual == 'OCUPADO' %}badge-warning
                                            {% else %}badge-secondary{% endif %}">
                                            {{ tecnico.get_estado_actual_display }}
                                        </span>
                                    </td>
                                    <td>{{ tecnico.telefono }}</td>
                                    <td>
                                        <div class="text-center">
                                            <span class="badge badge-primary">
                                                {{ tecnico.calificacion_promedio }}/5.0
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-info" onclick="viewTechnician('{{ tecnico.id }}')" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="editTechnician('{{ tecnico.id }}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteTechnician('{{ tecnico.id }}')" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="empty-state">
                                            <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">No hay técnicos registrados</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar técnico -->
<div class="modal fade" id="technicianModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Registrar Técnico</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="technicianForm" method="post" action="{% url 'administrador:tecnico_list' %}">
                {% csrf_token %}
                <input type="hidden" id="technicianId" name="tecnico_id">

                <div class="modal-body">
                    <!-- Información Personal -->
                    <h6 class="border-bottom pb-2 mb-3">Información Personal</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="tipoDocumento">Tipo de Documento</label>
                                <select id="tipoDocumento" name="tipo_documento" class="form-control" required>
                                    <option value="">Seleccione tipo</option>
                                    <option value="CC">Cédula de Ciudadanía</option>
                                    <option value="CE">Cédula de Extranjería</option>
                                    <option value="PAS">Pasaporte</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="numeroDocumento">Número de Documento</label>
                                <input type="text" id="numeroDocumento" name="numero_documento" class="form-control" required placeholder="123456789">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="telefono">Teléfono</label>
                                <input type="tel" id="telefono" name="telefono" class="form-control" required placeholder="3001234567">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="nombres">Nombres</label>
                                <input type="text" id="nombres" name="nombres" class="form-control" required placeholder="Nombres">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="apellidos">Apellidos</label>
                                <input type="text" id="apellidos" name="apellidos" class="form-control" required placeholder="Apellidos">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" class="form-control" required placeholder="ejemplo@correo.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="direccion">Dirección</label>
                                <input type="text" id="direccion" name="direccion" class="form-control" required placeholder="Dirección completa">
                            </div>
                        </div>
                    </div>

                    <!-- Información Técnica -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4">Información Técnica</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="especialidades">Especialidades</label>
                                <textarea id="especialidades" name="especialidades" class="form-control" rows="3" required placeholder="Descripción de especialidades técnicas"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="certificaciones">Certificaciones</label>
                                <textarea id="certificaciones" name="certificaciones" class="form-control" rows="3" placeholder="Certificaciones obtenidas (opcional)"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="nivelExperiencia">Nivel de Experiencia</label>
                                <select id="nivelExperiencia" name="nivel_experiencia" class="form-control" required>
                                    <option value="">Seleccione nivel</option>
                                    <option value="JUNIOR">Junior</option>
                                    <option value="INTERMEDIO">Intermedio</option>
                                    <option value="SENIOR">Senior</option>
                                    <option value="ESPECIALISTA">Especialista</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="fechaIngreso">Fecha de Ingreso</label>
                                <input type="date" id="fechaIngreso" name="fecha_ingreso" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="salario">Salario</label>
                                <input type="number" id="salario" name="salario" class="form-control" step="0.01" required placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="estadoActual">Estado Actual</label>
                        <select id="estadoActual" name="estado_actual" class="form-control" required>
                            <option value="">Seleccione estado</option>
                            <option value="DISPONIBLE">Disponible</option>
                            <option value="OCUPADO">Ocupado</option>
                            <option value="DESCANSO">En descanso</option>
                            <option value="VACACIONES">De vacaciones</option>
                            <option value="INCAPACITADO">Incapacitado</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Técnico</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function searchTechnicians() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const rows = document.querySelectorAll('.data-table tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm) || searchTerm === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function viewTechnician(id) {
    window.location.href = `/administrador/tecnicos/${id}/`;
}

function editTechnician(id) {
    alert('Funcionalidad de edición en desarrollo');
}

function deleteTechnician(id) {
    if (confirm('¿Estás seguro de que deseas eliminar este técnico?')) {
        alert('Técnico eliminado correctamente');
    }
}

function openModal() {
    $('#technicianModal').modal('show');
    document.getElementById('modalTitle').textContent = 'Registrar Técnico';
    document.getElementById('technicianForm').reset();
}

// Mostrar mensajes de Django
{% if messages %}
    {% for message in messages %}
        toastr.{{ message.tags }}('{{ message }}');
    {% endfor %}
{% endif %}
</script>
{% endblock %}
